# SMS Webhook - התחלה מהירה

## מה השתנה? 🚀

המערכת כעת מטפלת **אוטומטית** בתשובות SMS מהמוזמנים:

### זרימה פשוטה:

1. **מוזמן מקבל SMS:**
   ```
   שלום יוסי,
   אנו שמחים להזמינכם
   לחתונה של דוד ורות
   בתאריך 25/12/2025 בשעה 19:00
   מיקום: גן אירועים ירושלים
   נא הגיבו בהודעה חוזרת 1 אם אתם מגיעים, אחרת - 0.
   ```

2. **מוזמן מגיב "1":**
   ```
   מעולה! כמה תגיעו? (רשמו את מספר המגיעים, לדוגמא: 2)
   ```

3. **מוזמן מגיב "2":**
   ```
   תודה רבה! רשמנו 2 מגיעים. נשמח לראותכם!
   ```
   ✅ **סטטוס**: `confirmed`, **מגיעים**: `2`

**או:**

2. **מוזמן מגיב "0":**
   ```
   תודה על העדכון! נשמח לראותך בהזדמנות אחרת!
   ```
   ✅ **סטטוס**: `declined`, **מגיעים**: `0`

---

## הגדרה מהירה (5 דקות) ⚡

### שלב 1: Deploy הקוד
```bash
git add .
git commit -m "Add SMS webhook for automatic replies"
git push
```
המתן ל-Render לעשות deploy (2-3 דקות).

### שלב 2: הגדר Webhook ב-019SMS
1. כנס ל-[019SMS Dashboard](https://019sms.co.il/)
2. לך ל-**הגדרות** → **Webhooks** / **API Settings**
3. הוסף webhook חדש:
   - **URL:** `https://event-gift.onrender.com/api/sms-webhook/incoming`
   - **Method:** POST
   - **Event:** Incoming SMS / Message Received

### שלב 3: בדיקה
1. שלח SMS למוזמן מהמערכת
2. בקש מהמוזמן להגיב `1`
3. בדוק שהוא מקבל "כמה תגיעו?"
4. בקש מהמוזמן להגיב `2`
5. בדוק שהסטטוס התעדכן באתר ל-**confirmed** עם **2 מגיעים**

---

## Endpoints חדשים

### בדיקת תקינות
```bash
curl https://event-gift.onrender.com/api/sms-webhook/health
```

### בדיקת webhook (local)
```bash
curl -X POST "http://localhost:8000/api/sms-webhook/test?from_number=0501234567&message=1"
```

---

## מה קורה מאחורי הקלעים? 🔧

1. **019SMS מקבל תשובה** מהמוזמן
2. **019SMS שולח webhook** לשרת שלך עם ההודעה
3. **השרת מזהה** את המוזמן לפי מספר טלפון
4. **השרת מעדכן** את בסיס הנתונים:
   - סטטוס: `confirmed` / `declined` / `tentative`
   - מספר מגיעים
5. **השרת שולח תשובה אוטומטית** למוזמן דרך 019SMS API

---

## סטטוסים

| סטטוס | משמעות | מתי |
|-------|---------|-----|
| `pending` | ממתין לתשובה | ברירת מחדל |
| `tentative` | אישר הגעה, ממתין למספר | אחרי תשובה "1" |
| `confirmed` | אישר הגעה + מספר מגיעים | אחרי מספר מגיעים |
| `declined` | דחה את ההזמנה | אחרי תשובה "0" |

---

## בעיות נפוצות 🐛

### Webhook לא עובד?
1. ✅ בדוק שה-URL ב-019SMS נכון
2. ✅ בדוק logs ב-Render: Dashboard → Logs
3. ✅ ודא שהשרת פעיל: `/api/sms-webhook/health`

### סטטוס לא מתעדכן?
1. ✅ ודא שמספר הטלפון במאגר זהה למספר השולח
2. ✅ בדוק שהטבלה `guests` מכילה `status` ו-`attending_count`

---

## קבצים שנוספו

- 📄 `backend/sms_webhook.py` - לוגיקת webhook
- 📄 `backend/main.py` - רישום router
- 📄 `SMS_WEBHOOK_SETUP.md` - מדריך מלא
- 📄 `SMS_WEBHOOK_QUICK_START.md` - זה

---

**זהו! המערכת מוכנה לקבל ולענות לתשובות SMS אוטומטית! 🎉**
